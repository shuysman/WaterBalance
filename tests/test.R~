library(dplyr)
library(readr)
library(lubridate)
library(sf)
library(terra)
library(AOI)
library(climateR)
library(WaterBalance)

site_parameters <- read_csv(file.path("../PETE_site_parameters.csv")) %>%
    head(1) %>% ## Only use first site for testing
    st_as_sf(coords = c("Lon", "Lat"), crs = 4326)

start_date <- as_date("1980-01-01")
end_date <- as_date("1980-12-31")

## maca <- getMACA(site_parameters, timeRes = "daily", startDate = start_date, endDate = end_date)

gridmet <- getGridMET(site_parameters, startDate = start_date, endDate = end_date)

nps_gridded_rasters <- list.files(path  ="./test/data/", pattern = "*.nc", full.names = TRUE)
nps_gridded_data <- rast(nps_gridded_rasters[1])

## Historical gridded water balance files
## "Ground truth" to compare NPS water balance repo with
## http://www.yellowstone.solutions/thredds/catalog/daily_or_monthly/v2_historical/gridmet_v_1_5_historical/catalog.html
aet = rast(file.path("./test/data//V_1_5_1980_gridmet_historical_AET.nc4"))
pet = rast(file.path("./test/data//V_1_5_1980_gridmet_historical_PET.nc4"))
accumswe = rast(file.path("./test/data//V_1_5_1980_gridmet_historical_accumswe.nc4"))
deficit = rast(file.path("./test/data//V_1_5_1980_gridmet_historical_Deficit.nc4"))
runoff = rast(file.path("./test/data//V_1_5_1980_gridmet_historical_runoff.nc4"))
soil_water = rast(file.path("./test/data//V_1_5_1980_gridmet_historical_soil_water.nc4"))
rain = rast(file.path("./test/data//V_1_5_1980_gridmet_historical_rain.nc4"))

time_series <- tibble(date = time(nps_gridded_data)) %>%
    bind_cols(accumswe = terra::extract(accumswe, site_parameters, ID = FALSE) %>% as.double() / 10) %>%
    bind_cols(aet = terra::extract(aet, site_parameters, ID = FALSE) %>% as.double() / 10) %>%
    bind_cols(pet = terra::extract(pet, site_parameters, ID = FALSE) %>% as.double() / 10) %>%
    bind_cols(rain = terra::extract(rain, site_parameters, ID = FALSE) %>% as.double() / 10) %>%
    bind_cols(deficit = terra::extract(deficit, site_parameters, ID = FALSE) %>% as.double() / 10) %>%
    bind_cols(runoff = terra::extract(runoff, site_parameters, ID = FALSE) %>% as.double() / 10) %>%
    bind_cols(soil_water = terra::extract(soil_water, site_parameters, ID = FALSE) %>% as.double() / 10)


